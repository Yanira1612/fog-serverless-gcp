<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fog Computing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a2e; color: white; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: #16213e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; }
        .kpi { font-size: 2.2em; font-weight: bold; color: #4ecca3; }
        h1 { text-align: center; color: #4ecca3; }
        canvas { max-width: 100%; height: auto !important; }
        .peak-label { color: #e94560; }
        .ai-card { background: linear-gradient(135deg, #16213e 0%, #0f3460 100%); border: 2px solid #4ecca3; }
        .prediction-text { font-size: 1.5em; color: #4ecca3; margin: 10px 0; }
        .probability-bar { background: #1a1a2e; border-radius: 10px; height: 10px; width: 100%; margin-top: 5px; }
        .probability-fill { background: #4ecca3; height: 100%; border-radius: 10px; width: 0%; transition: width 1s; }
    </style>
</head>
<body>

    <h1>游 Panel de Control - Nodo Fog</h1>

    <div class="grid">
        <div class="card">
            <h3>Total de Eventos</h3>
            <div id="total-events" class="kpi">...</div>
        </div>
        <div class="card">
            <h3>C치maras Activas</h3>
            <div id="active-cameras" class="kpi">...</div>
        </div>
        <div class="card">
            <h3>Hora de Mayor Tr치fico</h3>
            <div id="peak-hour" class="kpi peak-label">...</div>
            <p style="margin-top: 10px; color: #888;">
                Promedio en esta hora: <span id="peak-avg" style="color: white; font-weight: bold;">0</span> personas
            </p>
        </div>
    </div>

    <div class="grid">
        <div class="card ai-card" id="ai-section" style="grid-column: 1 / -1;">
            <h3>游뱄 Predicci칩n del Sistema (IA)</h3>
            <p>Estado actual: <span id="current-state" style="font-weight: bold;">Cargando...</span></p>
                <div class="prediction-text">Pr칩ximo evento probable: <span id="predicted-event">...</span></div>
            <p>Probabilidad: <span id="probability-value">0</span>%</p>
            <div class="probability-bar"><div id="probability-fill" class="probability-fill"></div></div>
        </div>
    </div>


    <div class="grid">
        <div class="card">
            <h3>Distribuci칩n de Eventos</h3>
            <canvas id="chartTypes"></canvas>
        </div>
        <div class="card">
            <h3>Eventos por C치mara</h3>
            <canvas id="chartCameras"></canvas>
        </div>
    </div>

    <div class="grid">
        <div class="card" style="grid-column: 1 / -1;">
            <h3>Tendencia de Tr치fico (Hourly)</h3>
            <canvas id="chartTrend" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <script>
        const API_BASE = window.DASHBOARD_API_BASE || 'https://fog-analyst-654276264702.us-central1.run.app';
        const API_TOKEN = window.DASHBOARD_API_TOKEN || 'fog-analyst-0c6dc3c4';

        function withAuth(fetchUrl) {
            return fetch(fetchUrl, {
                headers: {
                    'X-API-KEY': API_TOKEN
                }
            });
        }

        withAuth(`${API_BASE}/metrics`)
            .then(res => res.json())
            .then(data => {
                // 1. KPIs
                document.getElementById('total-events').innerText = data.total_events;
                document.getElementById('active-cameras').innerText = Object.keys(data.cameras).length;
                document.getElementById('peak-hour').innerText = data.peak_hour;
                document.getElementById('peak-avg').innerText = data.peak_avg_people;

                // 2. Gr치fico Distribuci칩n
                new Chart(document.getElementById('chartTypes'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.distribution),
                        datasets: [{
                            data: Object.values(data.distribution),
                            backgroundColor: ['#e94560', '#0f3460', '#4ecca3', '#fca311']
                        }]
                    },
                    options: { plugins: { legend: { labels: { color: 'white' } } } }
                });

                // 3. Gr치fico C치maras
                new Chart(document.getElementById('chartCameras'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.cameras),
                        datasets: [{
                            label: 'Eventos',
                            data: Object.values(data.cameras),
                            backgroundColor: '#4ecca3'
                        }]
                    },
                    options: { 
                        scales: { 
                            y: { ticks: { color: 'white' } },
                            x: { ticks: { color: 'white' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                // 4. Gr치fico Tendencia (Corregido para usar hourly_counts)
                const trendData = data.hourly_counts || {};
                const sortedHours = Object.keys(trendData).sort();
                const trendValues = sortedHours.map(h => trendData[h]);

                new Chart(document.getElementById('chartTrend'), {
                    type: 'line',
                    data: {
                        labels: sortedHours,
                        datasets: [{
                            label: 'Volumen de Eventos',
                            data: trendValues,
                            borderColor: '#4ecca3',
                            backgroundColor: 'rgba(78, 204, 163, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        scales: {
                            y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        },
                        plugins: { legend: { labels: { color: 'white' } } }
                    }
                });

                // 5. Secci칩n IA
                // L칩gica de Predicci칩n IA
                const latest = data.latest_event;
                document.getElementById('current-state').innerText = latest;

                if (latest !== "UNKNOWN") {
                    withAuth(`${API_BASE}/predict_next?current_event=${latest}`)
                        .then(res => res.json())
                        .then(pred => {
                            document.getElementById('predicted-event').innerText = pred.prediction;
                            document.getElementById('probability-value').innerText = pred.probability;
                            document.getElementById('probability-fill').style.width = pred.probability + "%";
                        });
                }


            })
            .catch(err => console.error('Error:', err));
    </script>
</body>
</html>
