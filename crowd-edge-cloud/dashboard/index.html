<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fog Computing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a2e; color: white; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: #16213e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; }
        .kpi { font-size: 2.2em; font-weight: bold; color: #4ecca3; }
        h1 { text-align: center; color: #4ecca3; }
        canvas { max-width: 100%; height: auto !important; }
        .peak-label { color: #e94560; }
    </style>
</head>
<body>

    <h1>游 Panel de Control - Nodo Fog</h1>

    <div class="grid">
        <div class="card">
            <h3>Total de Eventos</h3>
            <div id="total-events" class="kpi">...</div>
        </div>
        <div class="card">
            <h3>C치maras Activas</h3>
            <div id="active-cameras" class="kpi">...</div>
        </div>
        <div class="card">
            <h3>Hora de Mayor Tr치fico</h3>
            <div id="peak-hour" class="kpi peak-label">...</div>
            <p style="margin-top: 10px; color: #888;">
                Promedio en esta hora: <span id="peak-avg" style="color: white; font-weight: bold;">0</span> personas
            </p>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Distribuci칩n de Eventos</h3>
            <canvas id="chartTypes"></canvas>
        </div>
        <div class="card">
            <h3>Eventos por C치mara</h3>
            <canvas id="chartCameras"></canvas>
        </div>
    </div>

    <div class="grid">
        <div class="card" style="grid-column: 1 / -1;">
            <h3>Tendencia de Tr치fico (Hourly)</h3>
            <canvas id="chartTrend" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <script>
        const API_URL = 'https://fog-analyst-654276264702.us-central1.run.app/metrics';

        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                // 1. KPIs
                document.getElementById('total-events').innerText = data.total_events;
                document.getElementById('active-cameras').innerText = Object.keys(data.cameras).length;
                document.getElementById('peak-hour').innerText = data.peak_hour;
                document.getElementById('peak-avg').innerText = data.peak_avg_people;

                // 2. Gr치fico Distribuci칩n
                new Chart(document.getElementById('chartTypes'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.distribution),
                        datasets: [{
                            data: Object.values(data.distribution),
                            backgroundColor: ['#e94560', '#0f3460', '#4ecca3', '#fca311']
                        }]
                    },
                    options: { plugins: { legend: { labels: { color: 'white' } } } }
                });

                // 3. Gr치fico C치maras
                new Chart(document.getElementById('chartCameras'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.cameras),
                        datasets: [{
                            label: 'Eventos',
                            data: Object.values(data.cameras),
                            backgroundColor: '#4ecca3'
                        }]
                    },
                    options: { 
                        scales: { 
                            y: { ticks: { color: 'white' } },
                            x: { ticks: { color: 'white' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                // 4. Gr치fico Tendencia (Corregido para usar hourly_counts)
                const trendData = data.hourly_counts || {};
                const sortedHours = Object.keys(trendData).sort();
                const trendValues = sortedHours.map(h => trendData[h]);

                new Chart(document.getElementById('chartTrend'), {
                    type: 'line',
                    data: {
                        labels: sortedHours,
                        datasets: [{
                            label: 'Volumen de Eventos',
                            data: trendValues,
                            borderColor: '#4ecca3',
                            backgroundColor: 'rgba(78, 204, 163, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        scales: {
                            y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        },
                        plugins: { legend: { labels: { color: 'white' } } }
                    }
                });
            })
            .catch(err => console.error('Error:', err));
    </script>
</body>
</html>